<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>YeÅŸil GÃ¼venlik - YÃ¶netim Paneli</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .gradient-green { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .gradient-blue { background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%); }
    .gradient-red { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .gradient-amber { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
    .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
    input, select, textarea { font-size: 16px !important; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .stat-card { position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%); }
    
    input[type="date"] { position: relative; }
    input[type="date"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
    input[type="date"]::after { content: "ðŸ“…"; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5; }
    input[type="date"]::before { color: #9ca3af; content: attr(placeholder); margin-right: 0.5em; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; }
    input[type="date"]:focus::before, input[type="date"]:valid::before { content: "" !important; display: none; }
    input[type="date"]:focus, input[type="date"]:valid { padding-left: 12px; }
    
    .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .custom-table th { background-color: #f9fafb; color: #374151; font-weight: 600; padding: 12px 16px; text-align: left; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
    .custom-table td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; color: #4b5563; }
    .custom-table tr:hover td { background-color: #f9fafb; }
    .custom-table tr:last-child td { border-bottom: none; }
  </style>
  <script>
    const APP_VERSION = 'v16';
    const storedVersion = localStorage.getItem('yesil_app_version');
    if (storedVersion !== APP_VERSION) {
      if ('caches' in window) { caches.keys().then(names => { names.forEach(name => caches.delete(name)); }); }
      localStorage.setItem('yesil_app_version', APP_VERSION);
    }
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const TEMEL_DONEMLER = ['119. DÃ¶nem', '120. DÃ¶nem', '121. DÃ¶nem', '122. DÃ¶nem', '123. DÃ¶nem', '124. DÃ¶nem'];
const YENILEME_DONEMLER = ['95. DÃ¶nem', '96. DÃ¶nem', '97. DÃ¶nem', '98. DÃ¶nem', '99. DÃ¶nem', '100. DÃ¶nem'];
const SINIFLAR = ['1', '2', '3', '4', '5'];
const GIDER_KATEGORILERI = ['Mermi', 'Poligon', 'EÄŸitmen', 'Kira', 'Personel', 'Mutfak', 'Vergi', 'DiÄŸer'];

const SHEETS_CONFIG = {
  WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbx54AokpsO6w8c0u_nrx3TpGpr2f_cDsUOEFycLgDiOqn-W3N0E2iDudS6KvdnFq1Al/exec',
  SHEET_NAMES: { KAYITLAR: 'Kayitlar', GIDERLER: 'Giderler', USERS: 'Users', LOGS: 'Logs', KASA: 'Kasa' }
};

const SheetsAPI = {
  async getSheet(sheetName) {
    try { const response = await fetch(SHEETS_CONFIG.WEB_APP_URL + '?sheet=' + sheetName); const result = await response.json(); return result.success ? (result.data || []) : []; }
    catch (error) { return []; }
  },
  async bulkUpdate(sheetName, rows) {
    try { const response = await fetch(SHEETS_CONFIG.WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ sheet: sheetName, action: 'bulkUpdate', data: rows }) }); const result = await response.json(); return result.success; }
    catch (error) { return false; }
  },
  rowToKayit(row) {
    if (!row || row.length < 2) return null;
    return { 
      id: parseInt(row[0]) || Date.now(), 
      adSoyad: row[1] || '', 
      tcKimlik: row[2] || '', 
      telefon: row[3] || '', 
      donem: row[4] || '', 
      egitimCesidi: row[5] || '', 
      egitimTuru: row[6] || '', 
      sinif: row[7] || '', 
      saglikRaporuTarihi: row[8] || '', 
      kayitTarihi: row[9] || '', 
      kayitSaati: row[10] || '', 
      toplamUcret: parseFloat(row[11]) || 0, 
      odenen: parseFloat(row[12]) || 0, 
      odemeTarihi: row[13] || '', 
      odemeTuru: row[14] || 'pesin', 
      taksitSayisi: parseInt(row[15]) || 0, 
      vadeTarihi: row[16] || '', 
      vadeTarihi2: row[17] || '', 
      makbuzNo: row[18] || '', 
      faturaKesildi: row[19] === 'true' || row[19] === true, 
      faturaNo: row[20] || '', 
      arsivlendi: row[21] === 'true' || row[21] === true, 
      aciklama: row[22] || '',
      sinavPuan: row[23] || '',
      duzenlemeTarihi: row[24] || '',
      gecerlilikSuresi: row[25] || '',
      belgeNo: row[26] || ''
    };
  },
  kayitToRow(k) { 
    return [
      k.id, k.adSoyad, k.tcKimlik, k.telefon, k.donem, k.egitimCesidi, k.egitimTuru, k.sinif, 
      k.saglikRaporuTarihi, k.kayitTarihi, k.kayitSaati, k.toplamUcret, k.odenen, k.odemeTarihi, 
      k.odemeTuru, k.taksitSayisi, k.vadeTarihi, k.vadeTarihi2, k.makbuzNo, k.faturaKesildi, 
      k.faturaNo, k.arsivlendi, k.aciklama, 
      k.sinavPuan, k.duzenlemeTarihi, k.gecerlilikSuresi, k.belgeNo
    ]; 
  },
  rowToGider(row) { if (!row || row.length < 2) return null; return { id: parseInt(row[0]) || Date.now(), kategori: row[1] || '', aciklama: row[2] || '', tutar: parseFloat(row[3]) || 0, tarih: row[4] || '' }; },
  giderToRow(g) { return [g.id, g.kategori, g.aciklama, g.tutar, g.tarih]; },
  kasaToRow(amount, date) { return [Date.now(), 'Kasa Borcu', amount, date || new Date().toISOString()]; }
};

const Icon = ({ name, size = 20, className = '' }) => {
  const ref = React.useRef(null);
  React.useEffect(() => { if (ref.current && lucide[name]) { ref.current.innerHTML = ''; const svg = lucide.createElement(lucide[name]); svg.setAttribute('width', size); svg.setAttribute('height', size); if (className) svg.setAttribute('class', className); ref.current.appendChild(svg); } }, [name, size, className]);
  return React.createElement('span', { ref, style: { display: 'inline-flex', alignItems: 'center' } });
};

const DB = {
  useSheets: true,
  async loadFromSheets() { 
    if (!this.useSheets) return { kayitlar: [], giderler: [], kasa_borc: 0 }; 
    try { 
      const kayitlarRows = await SheetsAPI.getSheet(SHEETS_CONFIG.SHEET_NAMES.KAYITLAR); 
      const giderlerRows = await SheetsAPI.getSheet(SHEETS_CONFIG.SHEET_NAMES.GIDERLER);
      const kasaRows = await SheetsAPI.getSheet(SHEETS_CONFIG.SHEET_NAMES.KASA);
      
      let kasaBorc = 0;
      if (kasaRows && kasaRows.length > 1) {
         const lastRow = kasaRows[kasaRows.length - 1];
         kasaBorc = parseFloat(lastRow[2]) || 0;
      }

      return { 
        kayitlar: kayitlarRows.slice(1).map(row => SheetsAPI.rowToKayit(row)).filter(Boolean), 
        giderler: giderlerRows.slice(1).map(row => SheetsAPI.rowToGider(row)).filter(Boolean),
        kasa_borc: kasaBorc
      }; 
    } catch (error) { return { kayitlar: [], giderler: [], kasa_borc: 0 }; } 
  },
  async saveKayitlarToSheets(kayitlar) { if (this.useSheets) { try { await SheetsAPI.bulkUpdate(SHEETS_CONFIG.SHEET_NAMES.KAYITLAR, kayitlar.map(k => SheetsAPI.kayitToRow(k))); } catch (e) {} } },
  async saveGiderlerToSheets(giderler) { if (this.useSheets) { try { await SheetsAPI.bulkUpdate(SHEETS_CONFIG.SHEET_NAMES.GIDERLER, giderler.map(g => SheetsAPI.giderToRow(g))); } catch (e) {} } },
  async saveKasaToSheets(amount, date) { if (this.useSheets) { try { await SheetsAPI.bulkUpdate(SHEETS_CONFIG.SHEET_NAMES.KASA, [SheetsAPI.kasaToRow(amount, date)]); } catch (e) {} } },
  
  get: (key) => { try { return JSON.parse(localStorage.getItem('yesil_' + key)) || (key === 'kasa_borc' ? 0 : []); } catch { return key === 'kasa_borc' ? 0 : []; } },
  set: (key, data, extra) => { 
    localStorage.setItem('yesil_' + key, JSON.stringify(data)); 
    if (key === 'kayitlar') DB.saveKayitlarToSheets(data); 
    else if (key === 'giderler') DB.saveGiderlerToSheets(data); 
    else if (key === 'kasa_borc') DB.saveKasaToSheets(data, extra); 
  },
  migrate: async () => { if (DB.useSheets) return await DB.loadFromSheets(); let k = DB.get('kayitlar'); if (!Array.isArray(k)) k = []; return { kayitlar: k.map(item => ({ ...item, odenen: item.odenen || 0, toplamUcret: item.toplamUcret || 0, arsivlendi: item.arsivlendi || false, sinif: item.sinif || '', odemeTuru: item.odemeTuru || 'pesin', taksitSayisi: item.taksitSayisi || 0, aciklama: item.aciklama || '' })), giderler: DB.get('giderler') || [], kasa_borc: DB.get('kasa_borc') || 0 }; }
};

const UserManager = {
  init: () => { if (!localStorage.getItem('yesil_users')) localStorage.setItem('yesil_users', JSON.stringify({ aksu: { password: 'Sa4175++', role: 'admin', name: 'YÃ¶netici', active: true }, yesil1: { password: 'Deneme123++', role: 'sekreter', name: 'Sekreter', active: true } })); },
  getUsers: () => { UserManager.init(); try { return JSON.parse(localStorage.getItem('yesil_users')) || {}; } catch { return {}; } },
  saveUsers: (users) => localStorage.setItem('yesil_users', JSON.stringify(users)),
  addUser: (username, password, role, name) => { const users = UserManager.getUsers(); users[username] = { password, role, name, active: true }; UserManager.saveUsers(users); return true; },
  updateUser: (username, updates) => { const users = UserManager.getUsers(); if (users[username]) { users[username] = { ...users[username], ...updates }; UserManager.saveUsers(users); return true; } return false; },
  deleteUser: (username) => { const users = UserManager.getUsers(); delete users[username]; UserManager.saveUsers(users); }
};

const ActivityLog = {
  log: (username, action, details = '') => { const logs = ActivityLog.getLogs(); logs.unshift({ id: Date.now(), username, action, details, timestamp: new Date().toISOString() }); if (logs.length > 500) logs.pop(); localStorage.setItem('yesil_activity_logs', JSON.stringify(logs)); },
  getLogs: () => { try { return JSON.parse(localStorage.getItem('yesil_activity_logs')) || []; } catch { return []; } },
  clearLogs: () => localStorage.setItem('yesil_activity_logs', JSON.stringify([]))
};

const Auth = {
  getCurrentUser: () => { try { const u = sessionStorage.getItem('yesil_user'); return u ? JSON.parse(u) : null; } catch { return null; } },
  login: (username, password) => { const users = UserManager.getUsers(); const user = users[username]; if (user && user.password === password && user.active !== false) { const userData = { username, role: user.role, name: user.name }; sessionStorage.setItem('yesil_user', JSON.stringify(userData)); ActivityLog.log(username, 'GÄ°RÄ°Åž', 'Sisteme giriÅŸ yaptÄ±'); return userData; } return null; },
  logout: () => { const user = Auth.getCurrentUser(); if (user) ActivityLog.log(user.username, 'Ã‡IKIÅž', 'Sistemden Ã§Ä±kÄ±ÅŸ yaptÄ±'); sessionStorage.removeItem('yesil_user'); }
};

const formatCurrency = (v) => (v || 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
const formatDate = (d) => d ? new Date(d).toLocaleDateString('tr-TR') : '-';
const formatPhone = (value) => { const cleaned = value.replace(/\D/g, ''); if (cleaned.length === 0) return '0(5'; if (cleaned.length === 1) return '0(5' + (cleaned === '0' || cleaned === '5' ? '' : cleaned); let num = cleaned.startsWith('05') ? cleaned : (cleaned.startsWith('5') ? '0' + cleaned : '05' + cleaned); if (num.length <= 4) return '0(' + num.slice(1); if (num.length <= 7) return '0(' + num.slice(1, 4) + ') ' + num.slice(4); if (num.length <= 9) return '0(' + num.slice(1, 4) + ') ' + num.slice(4, 7) + ' ' + num.slice(7); return '0(' + num.slice(1, 4) + ') ' + num.slice(4, 7) + ' ' + num.slice(7, 9) + ' ' + num.slice(9, 11); };
const exportToExcel = (data, filename, columns) => { let csv = columns.map(col => col.label).join(',') + '\n'; data.forEach(row => { csv += columns.map(col => { let value = row[col.key]; if (col.format) value = col.format(row); return '"' + (value || '').toString().replace(/"/g, '""') + '"'; }).join(',') + '\n'; }); const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv'; link.click(); };

function StatusBadge({ odenen, toplam }) { const kalan = toplam - odenen; if (kalan <= 0) return <span className="badge badge-success"><Icon name="CheckCircle2" size={14} /> Ã–dendi</span>; if (odenen > 0) return <span className="badge badge-warning"><Icon name="Clock" size={14} /> Taksitli</span>; return <span className="badge badge-danger"><Icon name="AlertCircle" size={14} /> Bekliyor</span>; }

function LoginScreen({ onLogin }) {
  const [username, setUsername] = React.useState(''); const [password, setPassword] = React.useState(''); const [error, setError] = React.useState('');
  const handleSubmit = (e) => { e.preventDefault(); const user = Auth.login(username, password); if (user) onLogin(user); else setError('KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!'); };
  return (<div className="min-h-screen flex items-center justify-center p-4"><div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden"><div className="gradient-green p-8 text-center text-white"><Icon name="Lock" size={48} className="mx-auto mb-4" /><h2 className="text-3xl font-bold mb-2">YeÅŸil GÃ¼venlik</h2><p className="text-green-100">EÄŸitim YÃ¶netim Sistemi</p></div><form onSubmit={handleSubmit} className="p-8 space-y-4">{error && <div className="bg-red-50 border-2 border-red-200 text-red-700 p-3 rounded-xl text-sm">{error}</div>}<div><label className="block text-sm font-semibold text-gray-700 mb-2">KullanÄ±cÄ± AdÄ±</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± giriniz" required /></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">Åžifre</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="Åžifrenizi giriniz" required /></div><button type="submit" className="w-full gradient-green text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition"><Icon name="LogIn" size={20} className="inline mr-2" />GiriÅŸ Yap</button></form></div></div>);
}

function TahsilatModal({ student, onClose, onConfirm }) {
  const kalan = (student.toplamUcret || 0) - (student.odenen || 0); const [tutar, setTutar] = React.useState(kalan); const [makbuz, setMakbuz] = React.useState('');
  return (<div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden fade-in"><div className="gradient-blue p-6 text-white"><div className="flex justify-between items-start"><div><h3 className="font-bold text-xl flex items-center gap-2 mb-1"><Icon name="Wallet" size={24} /> Tahsilat</h3><p className="text-blue-100 text-sm">{student.adSoyad}</p></div><button onClick={onClose} className="p-2 hover:bg-white/20 rounded-lg transition"><Icon name="X" size={20} /></button></div></div><form onSubmit={(e) => { e.preventDefault(); onConfirm(student.id, parseFloat(tutar), makbuz); }} className="p-6 space-y-4"><div className="bg-blue-50 rounded-2xl p-4 text-center"><p className="text-xs text-blue-600 font-semibold mb-1">Kalan Tutar</p><p className="text-3xl font-bold text-blue-900">{formatCurrency(kalan)}</p></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">Tahsilat TutarÄ±</label><input type="number" autoFocus max={kalan} min="0" step="0.01" required className="w-full p-4 border-2 border-blue-200 rounded-xl text-2xl font-bold text-center text-blue-900 focus:border-blue-500 focus:outline-none transition" value={tutar} onChange={e => setTutar(e.target.value)} /></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">Makbuz No</label><input type="text" required placeholder="Makbuz numarasÄ±" className="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition" value={makbuz} onChange={e => setMakbuz(e.target.value)} /></div><button className="w-full gradient-blue text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition"><Icon name="Check" size={20} className="inline mr-2" />TahsilatÄ± Onayla</button></form></div></div>);
}

function GiderModal({ onClose, onSave }) {
  const [form, setForm] = React.useState({ kategori: 'Mermi', aciklama: '', tutar: '', tarih: new Date().toISOString().split('T')[0] });
  return (<div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden fade-in"><div className="gradient-red p-6 text-white"><div className="flex justify-between items-center"><h3 className="font-bold text-xl flex items-center gap-2"><Icon name="TrendingDown" size={24} /> Gider Ekle</h3><button onClick={onClose} className="p-2 hover:bg-white/20 rounded-lg transition"><Icon name="X" size={20} /></button></div></div><div className="p-6 space-y-4"><div><label className="block text-sm font-semibold text-gray-700 mb-2">Kategori</label><select className="w-full p-4 border-2 border-gray-200 rounded-xl" value={form.kategori} onChange={e=>setForm({...form, kategori:e.target.value})}>{GIDER_KATEGORILERI.map(k=><option key={k}>{k}</option>)}</select></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">AÃ§Ä±klama</label><input className="w-full p-4 border-2 border-gray-200 rounded-xl" placeholder="Gider aÃ§Ä±klamasÄ±" value={form.aciklama} onChange={e=>setForm({...form, aciklama:e.target.value})} /></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">Tutar</label><input type="number" className="w-full p-4 border-2 border-gray-200 rounded-xl font-bold text-red-600 text-xl" placeholder="0.00" value={form.tutar} onChange={e=>setForm({...form, tutar:e.target.value})} /></div><div><label className="block text-sm font-semibold text-gray-700 mb-2">Tarih</label><input type="date" className="w-full p-4 border-2 border-gray-200 rounded-xl" value={form.tarih} onChange={e=>setForm({...form, tarih:e.target.value})} max="9999-12-31" /></div><button onClick={()=>onSave(form)} className="w-full gradient-red text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition"><Icon name="Save" size={20} className="inline mr-2" />Gideri Kaydet</button></div></div></div>);
}

function OgrenciCard({ item, onEdit, onDelete }) {
  return (<div className="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden card-hover"><div className="gradient-green p-4"><div className="flex items-start justify-between"><div className="flex-1"><h3 className="font-bold text-white text-lg mb-1">{item.adSoyad}</h3><p className="text-green-100 text-sm flex items-center gap-1"><Icon name="Calendar" size={14} /> {item.donem}</p></div><div className="flex gap-2"><button onClick={() => onEdit(item)} className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition"><Icon name="Edit2" size={18} className="text-white" /></button><button onClick={() => onDelete(item.id)} className="p-2 bg-white/20 hover:bg-red-500/80 rounded-lg transition"><Icon name="Trash2" size={18} className="text-white" /></button></div></div></div><div className="p-4 space-y-3"><div className="grid grid-cols-2 gap-3"><div className="bg-gray-50 rounded-xl p-3"><p className="text-xs text-gray-500 mb-1">TC Kimlik</p><p className="font-semibold text-sm">{item.tcKimlik}</p></div><div className="bg-gray-50 rounded-xl p-3"><p className="text-xs text-gray-500 mb-1">Telefon</p><p className="font-semibold text-sm">{item.telefon}</p></div></div><div className="flex items-center justify-between bg-emerald-50 rounded-xl p-3"><span className="text-sm font-semibold text-emerald-700">EÄŸitim</span><span className="text-sm font-bold text-emerald-900">{item.egitimCesidi} - {item.egitimTuru}</span></div>{item.sinif && <div className="flex items-center justify-between bg-blue-50 rounded-xl p-3"><span className="text-sm font-semibold text-blue-700">SÄ±nÄ±f</span><span className="text-sm font-bold text-blue-900">{item.sinif}</span></div>}</div></div>);
}

function MuhasebeCard({ item, onEdit, onTahsilat, onDelete }) {
  const kalan = (item.toplamUcret || 0) - (item.odenen || 0); const oran = item.toplamUcret > 0 ? ((item.odenen / item.toplamUcret) * 100) : 0;
  return (<div className="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden card-hover"><div className="p-4 border-b bg-gradient-to-r from-blue-50 to-white"><div className="flex items-start justify-between mb-2"><div><h3 className="font-bold text-gray-900">{item.adSoyad}</h3><p className="text-sm text-gray-500">{item.donem}</p></div><StatusBadge odenen={item.odenen} toplam={item.toplamUcret} /></div><div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div className="h-full bg-green-500 transition-all" style={{ width: Math.min(oran, 100) + '%' }}></div></div></div><div className="p-4 space-y-3"><div className="grid grid-cols-2 gap-3 text-sm"><div className="bg-gray-50 rounded-lg p-2"><p className="text-xs text-gray-500">TC</p><p className="font-semibold">{item.tcKimlik}</p></div><div className="bg-gray-50 rounded-lg p-2"><p className="text-xs text-gray-500">Telefon</p><p className="font-semibold">{item.telefon}</p></div><div className="bg-gray-50 rounded-lg p-2"><p className="text-xs text-gray-500">EÄŸitim TÃ¼rÃ¼</p><p className="font-semibold">{item.egitimCesidi}</p></div><div className="bg-gray-50 rounded-lg p-2"><p className="text-xs text-gray-500">Ã–deme TÃ¼rÃ¼</p><p className="font-semibold">{item.odemeTuru === 'taksit' ? 'Taksit (' + item.taksitSayisi + ')' : 'PeÅŸin'}</p></div></div><div className="grid grid-cols-2 gap-3"><div><p className="text-xs text-gray-500 mb-1">Toplam Ãœcret</p><p className="font-bold text-gray-900">{formatCurrency(item.toplamUcret)}</p></div><div><p className="text-xs text-gray-500 mb-1">Ã–denen</p><p className="font-bold text-green-600">{formatCurrency(item.odenen)}</p></div></div>{item.odemeTarihi && <div className="bg-green-50 rounded-xl p-3 text-sm"><p className="text-xs text-green-700 mb-1">1. Ã–deme Tarihi</p><p className="font-semibold text-green-900">{formatDate(item.odemeTarihi)}</p></div>}{item.odemeTuru === 'taksit' && item.vadeTarihi && <div className="bg-amber-50 rounded-xl p-3 text-sm"><p className="text-xs text-amber-700 mb-1">Vade Tarihi</p><p className="font-semibold text-amber-900">{formatDate(item.vadeTarihi)}</p></div>}{kalan > 0 && <div className="bg-amber-50 rounded-xl p-3 border border-amber-200"><p className="text-xs text-amber-700 mb-1">Kalan BorÃ§</p><p className="font-bold text-amber-900 text-xl">{formatCurrency(kalan)}</p></div>}{item.aciklama && <div className="bg-purple-50 rounded-xl p-3 text-sm"><p className="text-xs text-purple-700 mb-1">AÃ§Ä±klama</p><p className="font-semibold text-purple-900">{item.aciklama}</p></div>}<div className="flex gap-2 pt-2">{kalan > 0 && <button onClick={() => onTahsilat(item)} className="flex-1 gradient-blue text-white py-2.5 rounded-xl font-semibold text-sm shadow hover:shadow-lg transition"><Icon name="Wallet" size={16} className="inline mr-1" />Tahsilat</button>}<button onClick={() => onEdit(item)} className="px-4 bg-gray-100 hover:bg-gray-200 rounded-xl transition"><Icon name="Edit2" size={16} className="text-gray-600" /></button><button onClick={() => onDelete(item.id)} className="px-4 bg-gray-100 hover:bg-red-100 rounded-xl transition group"><Icon name="Trash2" size={16} className="text-gray-600 group-hover:text-red-600" /></button></div></div></div>);
}

function KayitForm({ editItem, viewMode, onClose, onSave }) {
  const getDonemler = (egitimTuru) => egitimTuru === 'Yenileme' ? YENILEME_DONEMLER : TEMEL_DONEMLER;
  const initialEgitimTuru = editItem?.egitimTuru || 'Temel';
  const [form, setForm] = React.useState(editItem || { adSoyad: '', tcKimlik: '', telefon: '0(5', donem: getDonemler(initialEgitimTuru)[0], egitimCesidi: 'SilahlÄ±', egitimTuru: initialEgitimTuru, sinif: '', saglikRaporuTarihi: '', kayitTarihi: '', kayitSaati: '', toplamUcret: 0, odenen: 0, odemeTarihi: '', odemeTuru: 'pesin', taksitSayisi: 2, vadeTarihi: '', vadeTarihi2: '', makbuzNo: '', faturaKesildi: false, faturaNo: '', aciklama: '', sinavPuan: '', duzenlemeTarihi: '', gecerlilikSuresi: '', belgeNo: '' });
  
  React.useEffect(() => { const donemler = getDonemler(form.egitimTuru); if (!donemler.includes(form.donem)) setForm(p => ({ ...p, donem: donemler[0] })); }, [form.egitimTuru]);
  
  const handleChange = (f, v) => setForm(p => ({ ...p, [f]: v }));
  const handleSaveWithDateTime = () => {
    if (form.tcKimlik && !/^\d{11}$/.test(form.tcKimlik)) { alert('TC Kimlik No 11 haneli rakamlardan oluÅŸmalÄ±dÄ±r!'); return; }
    if (form.telefon && form.telefon !== '0(5' && !/^05\d{9}$/.test(form.telefon.replace(/[\s()-]/g, ''))) { alert('Telefon numarasÄ± 10 haneli olmalÄ± ve 5 ile baÅŸlamalÄ±dÄ±r!'); return; }
    if (form.odenen > form.toplamUcret) { alert('Ã–denen tutar toplam Ã¼cretten fazla olamaz!'); return; }
    const now = new Date();
    onSave({ ...form, kayitTarihi: form.kayitTarihi || now.toISOString().split('T')[0], kayitSaati: form.kayitSaati || now.toTimeString().split(' ')[0].substring(0, 5) });
    alert('âœ… KayÄ±t baÅŸarÄ±yla kaydedildi!');
  };
  
  const showPersonal = viewMode === 'new' || viewMode === 'personal';
  const showFinancial = viewMode === 'new' || viewMode === 'financial';
  const currentDonemler = getDonemler(form.egitimTuru);

  return (
    <div className={viewMode === 'new' ? 'static' : 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm'}>
      <div className={'bg-white rounded-3xl w-full ' + (viewMode === 'new' ? 'max-w-5xl mx-auto shadow-lg border' : 'max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl')}>
        {viewMode !== 'new' && <div className="p-5 border-b sticky top-0 bg-white z-10 flex justify-between items-center rounded-t-3xl"><h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Icon name={viewMode === 'personal' ? 'User' : 'Receipt'} size={24} />{viewMode === 'personal' ? 'Kursiyer Bilgileri' : 'Muhasebe KaydÄ±'}</h3><button onClick={onClose} className="p-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition"><Icon name="X" size={20} /></button></div>}
        <div className="p-6">
          {showPersonal && <div className="mb-8"><h4 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><Icon name="UserCircle" size={20} className="text-green-600" />KiÅŸisel Bilgiler</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Ad Soyad</label><input className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="Ad Soyad" value={form.adSoyad} onChange={e=>handleChange('adSoyad',e.target.value)} /></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">TC Kimlik No</label><input className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="11 haneli TC" value={form.tcKimlik} onChange={e=>handleChange('tcKimlik',e.target.value)} maxLength="11" /></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Telefon</label><input className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="0(5__) ___ __ __" value={form.telefon} onChange={e=>handleChange('telefon', formatPhone(e.target.value))} maxLength="17" /></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">EÄŸitim TÃ¼rÃ¼</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" value={form.egitimTuru} onChange={e=>handleChange('egitimTuru',e.target.value)}><option>Temel</option><option>Yenileme</option><option value="Silah FarkÄ±">Silah FarkÄ±</option></select></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">DÃ¶nem</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" value={form.donem} onChange={e=>handleChange('donem',e.target.value)}>{currentDonemler.map(d=><option key={d}>{d}</option>)}</select></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">EÄŸitim Ã‡eÅŸidi</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" value={form.egitimCesidi} onChange={e=>handleChange('egitimCesidi',e.target.value)}><option>SilahlÄ±</option><option>SilahsÄ±z</option></select></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">SÄ±nÄ±f</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" value={form.sinif} onChange={e=>handleChange('sinif',e.target.value)}><option value="">SeÃ§iniz</option>{SINIFLAR.map(s=><option key={s}>{s}</option>)}</select></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">SaÄŸlÄ±k Raporu Tarihi</label><input type="date" required className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="gÃ¼n.ay.yÄ±l" value={form.saglikRaporuTarihi} onChange={e=>handleChange('saglikRaporuTarihi',e.target.value)} max="9999-12-31" /></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">KayÄ±t Tarihi</label><input type="text" className="w-full p-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-500" value={form.kayitTarihi ? formatDate(form.kayitTarihi) : ''} placeholder="Tarih Otomatik Verilecek" readOnly /></div>
            
            {/* YENÄ° ALANLAR BAÅžLANGIÃ‡ */}
            <div className="border-t pt-4 mt-2 md:col-span-2"><h5 className="font-bold text-gray-700 mb-2">Belge ve SÄ±nav Bilgileri</h5></div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">SÄ±nav Seviye PuanÄ±</label>
              <input type="number" min="0" max="100" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="0-100" value={form.sinavPuan} onChange={e=>{
                let val = parseInt(e.target.value);
                if (isNaN(val)) { handleChange('sinavPuan', ''); return; }
                if (val > 100) val = 100;
                if (val < 0) val = 0;
                handleChange('sinavPuan', val);
              }} />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Belge No</label>
              <input type="text" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="Belge NumarasÄ±" value={form.belgeNo} onChange={e=>handleChange('belgeNo',e.target.value)} />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">DÃ¼zenleme Tarihi</label>
              <input type="date" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="gÃ¼n.ay.yÄ±l" value={form.duzenlemeTarihi} onChange={e=>handleChange('duzenlemeTarihi',e.target.value)} max="9999-12-31" />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">GeÃ§erlilik SÃ¼resi</label>
              <input type="date" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="gÃ¼n.ay.yÄ±l" value={form.gecerlilikSuresi} onChange={e=>handleChange('gecerlilikSuresi',e.target.value)} max="9999-12-31" />
            </div>
            {/* YENÄ° ALANLAR BÄ°TÄ°Åž */}

          </div></div>}
          {showFinancial && <div><h4 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><Icon name="Receipt" size={20} className="text-blue-600" />Muhasebe Bilgileri</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Ã–deme TÃ¼rÃ¼</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" value={form.odemeTuru} onChange={e=>{const v=e.target.value;handleChange('odemeTuru',v);if(v==='pesin'){handleChange('taksitSayisi',0);handleChange('vadeTarihi','');handleChange('vadeTarihi2','');handleChange('odenen', form.toplamUcret);} else if(v==='taksit'){handleChange('odenen', 0);}}}><option value="pesin">PeÅŸin</option><option value="taksit">Taksit</option></select></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Toplam Ãœcret</label><input type="number" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-lg" placeholder="0.00" value={form.toplamUcret === 0 ? '' : form.toplamUcret} onChange={e=>{const val=parseFloat(e.target.value)||0; handleChange('toplamUcret',val); if(form.odemeTuru === 'pesin') handleChange('odenen', val);}} /></div>
            {form.odemeTuru === 'taksit' && <div><label className="block text-sm font-semibold text-gray-700 mb-2">Taksit SayÄ±sÄ±</label><select className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" value={form.taksitSayisi} onChange={e=>{const s=parseInt(e.target.value)||0;handleChange('taksitSayisi',s);if(s<3)handleChange('vadeTarihi2','');}}><option value="2">2 Taksit</option></select></div>}
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Ã–denen Tutar</label><input type="number" className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none font-bold text-lg text-green-600" placeholder="0.00" value={form.odenen === 0 ? '' : form.odenen} onChange={e=>{const val=parseFloat(e.target.value)||0;if(val<=form.toplamUcret)handleChange('odenen',val);else{handleChange('odenen',form.toplamUcret);alert('Ã–denen tutar toplam Ã¼cretten fazla olamaz!');}}} /></div>
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Ã–deme Tarihi</label><input type="date" required className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="gÃ¼n.ay.yÄ±l" value={form.odemeTarihi} onChange={e=>handleChange('odemeTarihi',e.target.value)} max="9999-12-31" /></div>
            {form.odemeTuru === 'taksit' && <div><label className="block text-sm font-semibold text-gray-700 mb-2">Vade Tarihi</label><input type="date" required className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="gÃ¼n.ay.yÄ±l" value={form.vadeTarihi} onChange={e=>handleChange('vadeTarihi',e.target.value)} max="9999-12-31" /></div>}
            <div><label className="block text-sm font-semibold text-gray-700 mb-2">Makbuz No</label><input className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="Makbuz No" value={form.makbuzNo} onChange={e=>handleChange('makbuzNo',e.target.value)} /></div>
            <div className="md:col-span-2"><label className="block text-sm font-semibold text-gray-700 mb-2">AÃ§Ä±klama</label><textarea className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none resize-none" placeholder="AÃ§Ä±klama (opsiyonel)" rows="2" value={form.aciklama} onChange={e=>handleChange('aciklama',e.target.value)} /></div>
            <div className="md:col-span-2"><label className="flex items-center gap-3 p-4 bg-blue-50 rounded-xl cursor-pointer hover:bg-blue-100 transition"><input type="checkbox" checked={form.faturaKesildi} onChange={e=>handleChange('faturaKesildi',e.target.checked)} className="w-5 h-5 text-blue-600 rounded" /><span className="font-semibold text-blue-900">Fatura Kesildi</span></label></div>
            {form.faturaKesildi && <div className="md:col-span-2"><label className="block text-sm font-semibold text-gray-700 mb-2">Fatura No</label><input className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="Fatura NumarasÄ±" value={form.faturaNo} onChange={e=>handleChange('faturaNo',e.target.value)} /></div>}
          </div></div>}
          <div className="flex gap-3 mt-8 pt-6 border-t">{viewMode !== 'new' && <button onClick={onClose} className="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-xl transition">Ä°ptal</button>}<button onClick={handleSaveWithDateTime} className="flex-1 gradient-green text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition"><Icon name="Save" size={20} className="inline mr-2" />Kaydet</button></div>
        </div>
      </div>
    </div>
  );
}

function KasaView({ kayitlar, giderler, onBorcChange }) {
  const [borcModal, setBorcModal] = React.useState(null); // 'al' veya 'ode'
  const [tutar, setTutar] = React.useState('');
  const [islemTarihi, setIslemTarihi] = React.useState(new Date().toISOString().split('T')[0]);
  const kasaBorc = DB.get('kasa_borc') || 0;

  const toplamOgrenciGeliri = kayitlar.filter(k => !k.arsivlendi).reduce((sum, k) => sum + (k.odenen || 0), 0);
  const toplamGider = giderler.reduce((sum, g) => sum + (g.tutar || 0), 0);
  const kasadakiPara = toplamOgrenciGeliri - toplamGider;

  const handleBorcIslem = (e) => {
    e.preventDefault();
    const val = parseFloat(tutar);
    if (!val || val <= 0) return;
    const yeniBorc = borcModal === 'al' ? kasaBorc + val : kasaBorc - val;
    onBorcChange(yeniBorc, islemTarihi);
    setBorcModal(null);
    setTutar('');
    setIslemTarihi(new Date().toISOString().split('T')[0]);
  };

  return (
    <div className="fade-in space-y-6">
       <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
         {/* Kasa Durumu */}
         <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div className="gradient-green p-6 text-white">
               <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="Landmark" size={24} /> Kasa Durumu</h2>
            </div>
            <div className="p-8 text-center">
              <p className="text-gray-500 font-medium mb-2">Kasadaki Toplam Para</p>
              <p className="text-4xl font-extrabold text-gray-800">{formatCurrency(kasadakiPara)}</p>
              <div className="mt-6 flex justify-between text-sm text-gray-500 px-4">
                <div className="text-center">
                   <p className="text-green-600 font-bold">{formatCurrency(toplamOgrenciGeliri)}</p>
                   <p>Gelir</p>
                </div>
                <div className="text-center">
                   <p className="text-red-600 font-bold">{formatCurrency(toplamGider)}</p>
                   <p>Gider</p>
                </div>
              </div>
            </div>
         </div>

         {/* BorÃ§ Durumu */}
         <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div className="gradient-purple p-6 text-white">
               <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="Wallet" size={24} /> BorÃ§ Takibi</h2>
            </div>
            <div className="p-8 text-center">
              <p className="text-gray-500 font-medium mb-2">Kasaya BorÃ§</p>
              <p className={"text-4xl font-extrabold " + (kasaBorc > 0 ? "text-purple-600" : "text-gray-400")}>{formatCurrency(kasaBorc)}</p>
              <div className="mt-6 flex gap-3">
                 <button onClick={()=>setBorcModal('al')} className="flex-1 py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-bold transition">BorÃ§ Al</button>
                 <button onClick={()=>setBorcModal('ode')} disabled={kasaBorc<=0} className="flex-1 py-3 bg-green-50 hover:bg-green-100 text-green-600 rounded-xl font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">BorÃ§ Ã–de</button>
              </div>
            </div>
         </div>
       </div>
       
       {borcModal && (
         <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
           <div className="bg-white rounded-3xl w-full max-w-sm shadow-2xl p-6 fade-in">
             <h3 className="text-xl font-bold mb-4">{borcModal === 'al' ? 'BorÃ§ Al' : 'BorÃ§ Ã–de'}</h3>
             <form onSubmit={handleBorcIslem}>
               <label className="block text-sm font-semibold text-gray-700 mb-2">Tarih</label>
               <input type="date" required max="9999-12-31" className="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 focus:border-blue-500 focus:outline-none" value={islemTarihi} onChange={e=>setIslemTarihi(e.target.value)} placeholder="gÃ¼n.ay.yÄ±l" />
               <label className="block text-sm font-semibold text-gray-700 mb-2">Tutar</label>
               <input type="number" autoFocus min="0" step="0.01" className="w-full p-4 border-2 border-gray-200 rounded-xl font-bold text-center text-2xl mb-4 focus:border-blue-500 focus:outline-none" value={tutar} onChange={e=>setTutar(e.target.value)} placeholder="0.00" />
               <div className="flex gap-3">
                 <button type="button" onClick={()=>setBorcModal(null)} className="flex-1 py-3 bg-gray-100 rounded-xl font-semibold">Ä°ptal</button>
                 <button type="submit" className={"flex-1 py-3 text-white rounded-xl font-bold shadow-lg " + (borcModal === 'al' ? 'gradient-red' : 'gradient-green')}>{borcModal === 'al' ? 'BorÃ§lan' : 'Ã–de'}</button>
               </div>
             </form>
           </div>
         </div>
       )}
    </div>
  );
}

function RaporView({ kayitlar, giderler }) {
  const [startDate, setStartDate] = React.useState(new Date().toISOString().split('T')[0]);
  const [endDate, setEndDate] = React.useState(new Date().toISOString().split('T')[0]);
  const [filterEgitimTuru, setFilterEgitimTuru] = React.useState('TÃ¼mÃ¼');
  const [filterEgitimCesidi, setFilterEgitimCesidi] = React.useState('TÃ¼mÃ¼');
  const [filterDonem, setFilterDonem] = React.useState('TÃ¼mÃ¼');
  const [filterSinif, setFilterSinif] = React.useState('TÃ¼mÃ¼');

  const setRange = (months) => {
    const end = new Date();
    const start = new Date();
    start.setMonth(start.getMonth() - months);
    setEndDate(end.toISOString().split('T')[0]);
    setStartDate(start.toISOString().split('T')[0]);
  };
  
  const setThisYear = () => {
    const now = new Date();
    setStartDate(now.getFullYear() + '-01-01');
    setEndDate(now.getFullYear() + '-12-31');
  };

  const filteredData = React.useMemo(() => {
     let filteredKayitlar = kayitlar.filter(k => {
       if (k.arsivlendi) return false;
       if (!k.kayitTarihi) return false;
       if (k.kayitTarihi < startDate || k.kayitTarihi > endDate) return false;
       if (filterEgitimTuru !== 'TÃ¼mÃ¼' && k.egitimTuru !== filterEgitimTuru) return false;
       if (filterEgitimCesidi !== 'TÃ¼mÃ¼' && k.egitimCesidi !== filterEgitimCesidi) return false;
       if (filterDonem !== 'TÃ¼mÃ¼' && k.donem !== filterDonem) return false;
       if (filterSinif !== 'TÃ¼mÃ¼' && k.sinif !== filterSinif) return false;
       return true;
     });

     const totalReceivable = filteredKayitlar.reduce((sum, k) => sum + (k.toplamUcret || 0), 0);
     const totalCollected = filteredKayitlar.reduce((sum, k) => sum + (k.odenen || 0), 0);
     
     const filteredGiderler = giderler.filter(g => g.tarih >= startDate && g.tarih <= endDate);
     const totalExpense = filteredGiderler.reduce((sum, g) => sum + (g.tutar || 0), 0);

     return { count: filteredKayitlar.length, totalReceivable, totalCollected, totalExpense, net: totalCollected - totalExpense };
  }, [kayitlar, giderler, startDate, endDate, filterEgitimTuru, filterEgitimCesidi, filterDonem, filterSinif]);

  return (
    <div className="fade-in space-y-6">
      <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-6">
        <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Filter" size={20} /> Rapor Kriterleri</h2>
        
        <div className="bg-gray-50 p-4 rounded-xl mb-6">
           <div className="flex flex-wrap gap-2 mb-4">
             <button onClick={()=>setRange(0)} className="px-3 py-1 bg-white border rounded-lg text-sm hover:bg-blue-50 text-gray-600">Bu Ay</button>
             <button onClick={()=>setRange(1)} className="px-3 py-1 bg-white border rounded-lg text-sm hover:bg-blue-50 text-gray-600">Son 1 Ay</button>
             <button onClick={()=>setRange(3)} className="px-3 py-1 bg-white border rounded-lg text-sm hover:bg-blue-50 text-gray-600">Son 3 Ay</button>
             <button onClick={()=>setRange(6)} className="px-3 py-1 bg-white border rounded-lg text-sm hover:bg-blue-50 text-gray-600">Son 6 Ay</button>
             <button onClick={setThisYear} className="px-3 py-1 bg-white border rounded-lg text-sm hover:bg-blue-50 text-gray-600">Bu YÄ±l</button>
           </div>
           <div className="grid grid-cols-2 gap-4">
             <div><label className="text-xs font-semibold text-gray-500">BaÅŸlangÄ±Ã§</label><input type="date" className="w-full p-2 border rounded-lg" value={startDate} onChange={e=>setStartDate(e.target.value)} /></div>
             <div><label className="text-xs font-semibold text-gray-500">BitiÅŸ</label><input type="date" className="w-full p-2 border rounded-lg" value={endDate} onChange={e=>setEndDate(e.target.value)} /></div>
           </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
           <div>
             <label className="text-xs font-semibold text-gray-500 mb-1 block">EÄŸitim TÃ¼rÃ¼</label>
             <select className="w-full p-2 border rounded-lg" value={filterEgitimTuru} onChange={e=>setFilterEgitimTuru(e.target.value)}>
               <option>TÃ¼mÃ¼</option><option>Temel</option><option>Yenileme</option><option value="Silah FarkÄ±">Silah FarkÄ±</option>
             </select>
           </div>
           <div>
             <label className="text-xs font-semibold text-gray-500 mb-1 block">EÄŸitim Ã‡eÅŸidi</label>
             <select className="w-full p-2 border rounded-lg" value={filterEgitimCesidi} onChange={e=>setFilterEgitimCesidi(e.target.value)}>
               <option>TÃ¼mÃ¼</option><option>SilahlÄ±</option><option>SilahsÄ±z</option>
             </select>
           </div>
           <div>
             <label className="text-xs font-semibold text-gray-500 mb-1 block">DÃ¶nem</label>
             <select className="w-full p-2 border rounded-lg" value={filterDonem} onChange={e=>setFilterDonem(e.target.value)}>
               <option>TÃ¼mÃ¼</option>{[...new Set([...TEMEL_DONEMLER, ...YENILEME_DONEMLER])].sort().map(d=><option key={d}>{d}</option>)}
             </select>
           </div>
           <div>
             <label className="text-xs font-semibold text-gray-500 mb-1 block">SÄ±nÄ±f</label>
             <select className="w-full p-2 border rounded-lg" value={filterSinif} onChange={e=>setFilterSinif(e.target.value)}>
               <option>TÃ¼mÃ¼</option>{SINIFLAR.map(s=><option key={s}>{s}</option>)}
             </select>
           </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
           <div className="p-4 bg-gray-50 rounded-2xl border border-gray-200">
             <p className="text-xs text-gray-500">KayÄ±t SayÄ±sÄ±</p>
             <p className="text-2xl font-bold text-gray-800">{filteredData.count}</p>
           </div>
           <div className="p-4 bg-blue-50 rounded-2xl border border-blue-100">
             <p className="text-xs text-blue-600">Toplam Alacak</p>
             <p className="text-xl font-bold text-blue-800">{formatCurrency(filteredData.totalReceivable)}</p>
           </div>
           <div className="p-4 bg-green-50 rounded-2xl border border-green-100">
             <p className="text-xs text-green-600">Tahsil Edilen</p>
             <p className="text-xl font-bold text-green-800">{formatCurrency(filteredData.totalCollected)}</p>
           </div>
           <div className="p-4 bg-red-50 rounded-2xl border border-red-100">
             <p className="text-xs text-red-600">Giderler</p>
             <p className="text-xl font-bold text-red-800">{formatCurrency(filteredData.totalExpense)}</p>
           </div>
           <div className={"p-4 rounded-2xl border " + (filteredData.net >= 0 ? "bg-emerald-50 border-emerald-100" : "bg-orange-50 border-orange-100")}>
             <p className={"text-xs " + (filteredData.net >= 0 ? "text-emerald-600" : "text-orange-600")}>Net Kasa</p>
             <p className={"text-xl font-bold " + (filteredData.net >= 0 ? "text-emerald-800" : "text-orange-800")}>{formatCurrency(filteredData.net)}</p>
           </div>
        </div>
      </div>
    </div>
  );
}

function App() {
  const [currentUser, setCurrentUser] = React.useState(null);
  const [activeTab, setActiveTab] = React.useState('dashboard');
  const [menuOpen, setMenuOpen] = React.useState(false);
  const [kayitlar, setKayitlar] = React.useState([]);
  const [giderler, setGiderler] = React.useState([]);
  const [searchTerm, setSearchTerm] = React.useState('');
  
  const [listFilterEgitimTuru, setListFilterEgitimTuru] = React.useState('TÃ¼mÃ¼');
  const [listFilterDonem, setListFilterDonem] = React.useState('TÃ¼mÃ¼');
  const [listFilterSinif, setListFilterSinif] = React.useState('TÃ¼mÃ¼');

  const [viewMode, setViewMode] = React.useState('card');
  const [editModal, setEditModal] = React.useState({open:false, item:null, mode:null});
  const [tahsilatModal, setTahsilatModal] = React.useState(null);
  const [giderModal, setGiderModal] = React.useState(false);
  const [users, setUsers] = React.useState({});
  const [activityLogs, setActivityLogs] = React.useState([]);
  const [kasaBorc, setKasaBorc] = React.useState(0);

  const TUM_DONEMLER = [...new Set([...TEMEL_DONEMLER, ...YENILEME_DONEMLER])].sort((a, b) => parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0]));

  React.useEffect(() => { 
    const user = Auth.getCurrentUser(); 
    if (user) { 
      setCurrentUser(user); 
      DB.migrate().then(data => { 
        setKayitlar(data.kayitlar); 
        setGiderler(data.giderler); 
        setUsers(UserManager.getUsers()); 
        setActivityLogs(ActivityLog.getLogs());
        setKasaBorc(data.kasa_borc || 0);
      }); 
    } 
  }, []);

  React.useEffect(() => { if (currentUser && currentUser.role === 'sekreter') setActiveTab('yeni_kayit'); else if (currentUser && currentUser.role === 'admin') setActiveTab('dashboard'); }, [currentUser]);

  const handleLogin = (user) => { setCurrentUser(user); DB.migrate().then(data => { setKayitlar(data.kayitlar); setGiderler(data.giderler); setKasaBorc(data.kasa_borc || 0); }); };
  const handleLogout = () => { Auth.logout(); setCurrentUser(null); setKayitlar([]); setGiderler([]); };
  
  const MENU = currentUser ? [
    { id: 'dashboard', label: 'Ana Sayfa', icon: 'LayoutDashboard', roles: ['admin'] },
    { id: 'yeni_kayit', label: 'Yeni KayÄ±t', icon: 'UserPlus', roles: ['admin', 'sekreter'] },
    { id: 'kursiyer', label: 'Kursiyerler', icon: 'Users', roles: ['admin', 'sekreter'] },
    { id: 'muhasebe', label: 'Muhasebe', icon: 'Receipt', roles: ['admin'] },
    { id: 'kasa', label: 'Kasa', icon: 'Landmark', roles: ['admin'] },
    { id: 'raporlar', label: 'Raporlar', icon: 'BarChart3', roles: ['admin'] },
    { id: 'giderler', label: 'Giderler', icon: 'TrendingDown', roles: ['admin'] },
    { id: 'arsiv', label: 'ArÅŸiv', icon: 'Archive', roles: ['admin'] },
    { id: 'yonetim', label: 'YÃ¶netim Paneli', icon: 'Settings', roles: ['admin'] },
  ].filter(item => item.roles.includes(currentUser.role)) : [];

  if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

  const handleSave = async (form) => { const isNew = !form.id; const yeni = form.id ? kayitlar.map(k => k.id === form.id ? form : k) : [...kayitlar, { ...form, id: Date.now() }]; setKayitlar(yeni); DB.set('kayitlar', yeni); setEditModal({open:false, item:null, mode:null}); ActivityLog.log(currentUser.username, isNew ? 'YENÄ° KAYIT' : 'KAYIT GÃœNCELLEME', form.adSoyad + ' - ' + form.donem); };
  const handleTahsilat = (id, tutar, makbuz) => { const ogrenci = kayitlar.find(k => k.id === id); const yeni = kayitlar.map(k => k.id === id ? { ...k, odenen: (k.odenen || 0) + tutar, makbuzNo: makbuz } : k); setKayitlar(yeni); DB.set('kayitlar', yeni); setTahsilatModal(null); ActivityLog.log(currentUser.username, 'TAHSÄ°LAT', ogrenci?.adSoyad + ' - ' + formatCurrency(tutar)); };
  const saveGider = (form) => { if (!form.tutar || !form.aciklama) return; const yeni = [...giderler, { ...form, id: Date.now(), tutar: parseFloat(form.tutar) }]; setGiderler(yeni); DB.set('giderler', yeni); setGiderModal(false); ActivityLog.log(currentUser.username, 'GÄ°DER EKLEME', form.kategori + ' - ' + formatCurrency(form.tutar)); };
  const deleteGider = (id) => { if (!confirm('Bu gideri silmek istediÄŸinize emin misiniz?')) return; const gider = giderler.find(g => g.id === id); const yeni = giderler.filter(g => g.id !== id); setGiderler(yeni); DB.set('giderler', yeni); ActivityLog.log(currentUser.username, 'GÄ°DER SÄ°LME', gider?.kategori + ' - ' + formatCurrency(gider?.tutar)); };
  
  const handleArchive = (id) => {
    if (!confirm('Bu kaydÄ± arÅŸive gÃ¶ndermek (silmek) istediÄŸinize emin misiniz?')) return;
    const item = kayitlar.find(k => k.id === id);
    const yeni = kayitlar.map(k => k.id === id ? { ...k, arsivlendi: true } : k);
    setKayitlar(yeni);
    DB.set('kayitlar', yeni);
    ActivityLog.log(currentUser.username, 'KAYIT ARÅžÄ°VLEME', item?.adSoyad);
  };

  const handleKasaBorcChange = (val, date) => {
    setKasaBorc(val);
    DB.set('kasa_borc', val, date);
    ActivityLog.log(currentUser.username, 'BORÃ‡ GÃœNCELLEME', 'Yeni Bakiye: ' + formatCurrency(val));
  };

  const filteredKayitlar = kayitlar.filter(k => { 
    if (k.arsivlendi) return false; 
    const matchSearch = !searchTerm || k.adSoyad?.toLowerCase().includes(searchTerm.toLowerCase()) || k.tcKimlik?.includes(searchTerm) || k.telefon?.includes(searchTerm); 
    const matchDonem = listFilterDonem === 'TÃ¼mÃ¼' || k.donem === listFilterDonem;
    const matchEgitimTuru = listFilterEgitimTuru === 'TÃ¼mÃ¼' || k.egitimTuru === listFilterEgitimTuru;
    const matchSinif = listFilterSinif === 'TÃ¼mÃ¼' || k.sinif === listFilterSinif;
    return matchSearch && matchDonem && matchEgitimTuru && matchSinif; 
  });
  
  const stats = { toplamOgrenci: kayitlar.filter(k => !k.arsivlendi).length, toplamGelir: kayitlar.filter(k => !k.arsivlendi).reduce((sum, k) => sum + (k.odenen || 0), 0), bekleyenTahsilat: kayitlar.filter(k => !k.arsivlendi).reduce((sum, k) => sum + ((k.toplamUcret || 0) - (k.odenen || 0)), 0), toplamGider: giderler.reduce((sum, g) => sum + (g.tutar || 0), 0) };

  const FilterBar = () => (
    <div className="flex flex-col md:flex-row gap-3 mb-6 bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
      <div className="flex-1 relative"><Icon name="Search" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input className="w-full pl-12 pr-4 py-2 border-2 border-gray-100 rounded-xl focus:border-blue-500 focus:outline-none transition" placeholder="Ad, TC veya telefon..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
      <select className="px-3 py-2 border-2 border-gray-100 rounded-xl focus:border-blue-500 focus:outline-none bg-white" value={listFilterEgitimTuru} onChange={e => setListFilterEgitimTuru(e.target.value)}><option>TÃ¼mÃ¼</option><option>Temel</option><option>Yenileme</option><option value="Silah FarkÄ±">Silah FarkÄ±</option></select>
      <select className="px-3 py-2 border-2 border-gray-100 rounded-xl focus:border-blue-500 focus:outline-none bg-white" value={listFilterDonem} onChange={e => setListFilterDonem(e.target.value)}><option>TÃ¼mÃ¼</option>{TUM_DONEMLER.map(d => <option key={d}>{d}</option>)}</select>
      <select className="px-3 py-2 border-2 border-gray-100 rounded-xl focus:border-blue-500 focus:outline-none bg-white" value={listFilterSinif} onChange={e => setListFilterSinif(e.target.value)}><option>TÃ¼mÃ¼</option>{SINIFLAR.map(s => <option key={s}>{s}</option>)}</select>
      <div className="flex bg-gray-100 p-1 rounded-xl shrink-0">
        <button onClick={()=>setViewMode('card')} className={"p-2 rounded-lg transition " + (viewMode==='card'?'bg-white shadow text-green-600':'text-gray-500')}><Icon name="LayoutGrid" size={20} /></button>
        <button onClick={()=>setViewMode('table')} className={"p-2 rounded-lg transition " + (viewMode==='table'?'bg-white shadow text-green-600':'text-gray-500')}><Icon name="Table" size={20} /></button>
      </div>
      <button onClick={() => exportToExcel(filteredKayitlar, activeTab, [{ key: 'adSoyad', label: 'Ad Soyad' }, { key: 'tcKimlik', label: 'TC Kimlik' }, { key: 'telefon', label: 'Telefon' }, { key: 'donem', label: 'DÃ¶nem' }, { key: 'sinif', label: 'SÄ±nÄ±f' }, { key: 'egitimCesidi', label: 'EÄŸitim Ã‡eÅŸidi' }, { key: 'egitimTuru', label: 'EÄŸitim TÃ¼rÃ¼' }])} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold flex items-center gap-2 transition shrink-0"><Icon name="Download" size={18} />Excel</button>
    </div>
  );

  return (
    <div className="min-h-screen pb-20 md:pb-0">
      <header className="glass sticky top-0 z-30 shadow-sm"><div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between"><button onClick={() => setMenuOpen(true)} className="md:hidden p-2 hover:bg-gray-100 rounded-xl transition"><Icon name="Menu" size={24} /></button><h1 className="text-xl font-bold text-gray-800 hidden md:block"><span className="text-green-600">YeÅŸil</span> GÃ¼venlik</h1><div className="flex items-center gap-4"><div className="text-right"><p className="font-semibold text-gray-800">{currentUser.name}</p><p className="text-xs text-gray-500">{currentUser.role === 'admin' ? 'YÃ¶netici' : 'Sekreter'}</p></div><button onClick={handleLogout} className="p-2 hover:bg-red-50 text-red-600 rounded-xl transition" title="Ã‡Ä±kÄ±ÅŸ Yap"><Icon name="LogOut" size={20} /></button></div></div></header>

      {menuOpen && <div className="fixed inset-0 z-50"><div className="absolute inset-0 bg-black/50" onClick={() => setMenuOpen(false)}></div><div className="absolute left-0 top-0 bottom-0 w-72 bg-white shadow-2xl slide-in"><div className="gradient-green p-6 text-white"><h2 className="text-xl font-bold">YeÅŸil GÃ¼venlik</h2><p className="text-green-100 text-sm mt-1">YÃ¶netim Paneli</p></div><nav className="p-4 space-y-2">{MENU.map(item => (<button key={item.id} onClick={() => { setActiveTab(item.id); setMenuOpen(false); }} className={'w-full flex items-center gap-3 p-4 rounded-xl transition ' + (activeTab === item.id ? 'bg-green-50 text-green-700 font-semibold' : 'hover:bg-gray-50 text-gray-700')}><Icon name={item.icon} size={20} />{item.label}</button>))}</nav></div></div>}

      <div className="max-w-7xl mx-auto flex">
        <aside className="hidden md:block w-64 p-4 sticky top-16 h-[calc(100vh-4rem)]"><nav className="bg-white rounded-2xl shadow-md p-4 space-y-2">{MENU.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={'w-full flex items-center gap-3 p-3 rounded-xl transition ' + (activeTab === item.id ? 'gradient-green text-white font-semibold shadow-lg' : 'hover:bg-gray-100 text-gray-700')}><Icon name={item.icon} size={20} />{item.label}</button>))}</nav></aside>

        <main className="flex-1 p-4">
          {activeTab === 'dashboard' && currentUser.role === 'admin' && (
            <div className="fade-in">
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="stat-card gradient-green text-white rounded-2xl p-5 shadow-lg"><Icon name="Users" size={28} className="mb-2 opacity-80" /><p className="text-3xl font-bold">{stats.toplamOgrenci}</p><p className="text-sm text-green-100">Toplam Kursiyer</p></div>
                <div className="stat-card gradient-blue text-white rounded-2xl p-5 shadow-lg"><Icon name="TrendingUp" size={28} className="mb-2 opacity-80" /><p className="text-2xl font-bold">{formatCurrency(stats.toplamGelir)}</p><p className="text-sm text-blue-100">Toplam Gelir</p></div>
                <div className="stat-card gradient-amber text-white rounded-2xl p-5 shadow-lg"><Icon name="Clock" size={28} className="mb-2 opacity-80" /><p className="text-2xl font-bold">{formatCurrency(stats.bekleyenTahsilat)}</p><p className="text-sm text-amber-100">Bekleyen</p></div>
                <div className="stat-card gradient-red text-white rounded-2xl p-5 shadow-lg"><Icon name="TrendingDown" size={28} className="mb-2 opacity-80" /><p className="text-2xl font-bold">{formatCurrency(stats.toplamGider)}</p><p className="text-sm text-red-100">Toplam Gider</p></div>
              </div>
              <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-6"><h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Zap" size={24} className="text-amber-500" />HÄ±zlÄ± Ä°ÅŸlemler</h2><div className="grid grid-cols-2 md:grid-cols-4 gap-4"><button onClick={()=>setActiveTab('yeni_kayit')} className="p-4 bg-green-50 hover:bg-green-100 rounded-xl text-center transition group"><Icon name="UserPlus" size={32} className="text-green-600 mx-auto mb-2 group-hover:scale-110 transition" /><p className="font-semibold text-sm text-gray-700">Yeni KayÄ±t</p></button><button onClick={()=>setActiveTab('muhasebe')} className="p-4 bg-blue-50 hover:bg-blue-100 rounded-xl text-center transition group"><Icon name="Wallet" size={32} className="text-blue-600 mx-auto mb-2 group-hover:scale-110 transition" /><p className="font-semibold text-sm text-gray-700">Tahsilat</p></button><button onClick={()=>setGiderModal(true)} className="p-4 bg-red-50 hover:bg-red-100 rounded-xl text-center transition group"><Icon name="TrendingDown" size={32} className="text-red-600 mx-auto mb-2 group-hover:scale-110 transition" /><p className="font-semibold text-sm text-gray-700">Gider Ekle</p></button><button onClick={()=>setActiveTab('kursiyer')} className="p-4 bg-purple-50 hover:bg-purple-100 rounded-xl text-center transition group"><Icon name="Users" size={32} className="text-purple-600 mx-auto mb-2 group-hover:scale-110 transition" /><p className="font-semibold text-sm text-gray-700">Kursiyerler</p></button></div></div>
            </div>
          )}

          {activeTab === 'yeni_kayit' && <div className="fade-in pb-10"><div className="max-w-5xl mx-auto mb-6"><h2 className="text-3xl font-bold text-gray-800 mb-2">Yeni Kursiyer KaydÄ±</h2><p className="text-gray-500">Kursiyer kimlik ve muhasebe bilgilerini eksiksiz giriniz.</p></div><KayitForm viewMode="new" editItem={null} onSave={handleSave} /></div>}

          {activeTab === 'kursiyer' && (
            <div className="fade-in">
              <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Kursiyer Listesi</h2><p className="text-sm text-gray-500">{filteredKayitlar.length} kayÄ±t bulundu</p></div>
              <FilterBar />
              {viewMode === 'card' ? (
                <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">{filteredKayitlar.map(k => <OgrenciCard key={k.id} item={k} onEdit={(item)=>setEditModal({ open: true, item, mode: 'personal' })} onDelete={handleArchive} />)}</div>
              ) : (
                 <div className="bg-white rounded-2xl shadow border border-gray-100 overflow-x-auto">
                   <table className="custom-table">
                     <thead><tr><th>Ad Soyad</th><th>TC Kimlik</th><th>Telefon</th><th>DÃ¶nem</th><th>EÄŸitim</th><th>SÄ±nÄ±f</th><th>Ä°ÅŸlemler</th></tr></thead>
                     <tbody>
                       {filteredKayitlar.map(k => (
                         <tr key={k.id}>
                           <td className="font-semibold text-gray-900">{k.adSoyad}</td>
                           <td>{k.tcKimlik}</td>
                           <td>{k.telefon}</td>
                           <td><span className="badge badge-success">{k.donem}</span></td>
                           <td>{k.egitimCesidi} - {k.egitimTuru}</td>
                           <td>{k.sinif}</td>
                           <td className="flex gap-2">
                             <button onClick={()=>setEditModal({ open: true, item: k, mode: 'personal' })} className="p-1.5 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg"><Icon name="Edit2" size={16} /></button>
                             <button onClick={()=>handleArchive(k.id)} className="p-1.5 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg"><Icon name="Trash2" size={16} /></button>
                           </td>
                         </tr>
                       ))}
                     </tbody>
                   </table>
                 </div>
              )}
              {filteredKayitlar.length === 0 && <div className="text-center py-16"><Icon name="Search" size={64} className="text-gray-300 mx-auto mb-4" /><p className="text-gray-400 font-semibold">Kursiyer bulunamadÄ±</p></div>}
            </div>
          )}

          {activeTab === 'muhasebe' && currentUser.role === 'admin' && (
            <div className="fade-in">
              <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Muhasebe KayÄ±tlarÄ±</h2><p className="text-sm text-gray-500">{filteredKayitlar.length} kayÄ±t bulundu</p></div>
              <FilterBar />
              {viewMode === 'card' ? (
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">{filteredKayitlar.map(k => <MuhasebeCard key={k.id} item={k} onEdit={(item)=>setEditModal({ open: true, item, mode: 'financial' })} onTahsilat={(item)=>setTahsilatModal(item)} onDelete={handleArchive} />)}</div>
              ) : (
                <div className="bg-white rounded-2xl shadow border border-gray-100 overflow-x-auto">
                   <table className="custom-table">
                     <thead><tr><th>Ad Soyad</th><th>DÃ¶nem</th><th>Toplam Ãœcret</th><th>Ã–denen</th><th>Kalan</th><th>Durum</th><th>Ä°ÅŸlemler</th></tr></thead>
                     <tbody>
                       {filteredKayitlar.map(k => {
                         const kalan = (k.toplamUcret || 0) - (k.odenen || 0);
                         return (
                           <tr key={k.id}>
                             <td className="font-semibold text-gray-900">{k.adSoyad}</td>
                             <td>{k.donem}</td>
                             <td className="font-bold">{formatCurrency(k.toplamUcret)}</td>
                             <td className="text-green-600">{formatCurrency(k.odenen)}</td>
                             <td className={kalan > 0 ? "text-red-600 font-bold" : "text-gray-400"}>{formatCurrency(kalan)}</td>
                             <td><StatusBadge odenen={k.odenen} toplam={k.toplamUcret} /></td>
                             <td className="flex gap-2">
                               {kalan > 0 && <button onClick={()=>setTahsilatModal(k)} title="Tahsilat" className="p-1.5 text-green-600 bg-green-50 hover:bg-green-100 rounded-lg"><Icon name="Wallet" size={16} /></button>}
                               <button onClick={()=>setEditModal({ open: true, item: k, mode: 'financial' })} title="DÃ¼zenle" className="p-1.5 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg"><Icon name="Edit2" size={16} /></button>
                               <button onClick={()=>handleArchive(k.id)} title="Sil" className="p-1.5 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg"><Icon name="Trash2" size={16} /></button>
                             </td>
                           </tr>
                         );
                       })}
                     </tbody>
                   </table>
                 </div>
              )}
            </div>
          )}

          {activeTab === 'kasa' && currentUser.role === 'admin' && <KasaView kayitlar={kayitlar} giderler={giderler} onBorcChange={handleKasaBorcChange} />}
          
          {activeTab === 'raporlar' && currentUser.role === 'admin' && <RaporView kayitlar={kayitlar} giderler={giderler} />}

          {activeTab === 'giderler' && currentUser.role === 'admin' && (
            <div className="fade-in">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"><div><h2 className="text-2xl font-bold text-gray-800">Gider YÃ¶netimi</h2><p className="text-gray-500 text-sm mt-1">Toplam {giderler.length} gider kaydÄ±</p></div><div className="flex gap-3"><button onClick={() => exportToExcel(giderler, 'giderler', [{ key: 'kategori', label: 'Kategori' }, { key: 'aciklama', label: 'AÃ§Ä±klama' }, { key: 'tutar', label: 'Tutar', format: (r) => formatCurrency(r.tutar) }, { key: 'tarih', label: 'Tarih', format: (r) => formatDate(r.tarih) }])} className="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold flex items-center gap-2 transition"><Icon name="Download" size={18} />Excel</button><button onClick={()=>setGiderModal(true)} className="gradient-red text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition"><Icon name="Plus" size={20}/>Gider Ekle</button></div></div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">{GIDER_KATEGORILERI.map(kategori => { const toplamTutar = giderler.filter(g => g.kategori === kategori).reduce((sum, g) => sum + (g.tutar || 0), 0); const adet = giderler.filter(g => g.kategori === kategori).length; return (<div key={kategori} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 card-hover"><p className="text-xs text-gray-500 mb-2">{kategori}</p><p className="text-2xl font-bold text-red-600">{formatCurrency(toplamTutar)}</p><p className="text-xs text-gray-400 mt-1">{adet} iÅŸlem</p></div>); })}</div>
              <div className="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden"><div className="divide-y">{giderler.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).map(g => (<div key={g.id} className="p-5 flex items-center justify-between hover:bg-red-50/30 transition group"><div className="flex items-center gap-4 flex-1"><div className="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center"><Icon name="TrendingDown" size={24} className="text-red-600" /></div><div className="flex-1"><div className="flex items-center gap-3 mb-1"><span className="badge badge-danger">{g.kategori}</span><p className="text-xs text-gray-400 flex items-center gap-1"><Icon name="Calendar" size={12} />{formatDate(g.tarih)}</p></div><p className="font-semibold text-gray-900">{g.aciklama}</p></div></div><div className="flex items-center gap-4"><p className="font-bold text-red-600 text-2xl">-{formatCurrency(g.tutar)}</p><button onClick={()=>deleteGider(g.id)} className="p-2.5 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-xl transition opacity-0 group-hover:opacity-100"><Icon name="Trash2" size={18}/></button></div></div>))}</div>{giderler.length === 0 && <div className="text-center py-20"><Icon name="TrendingDown" size={48} className="text-gray-300 mx-auto mb-4" /><p className="text-gray-400 font-semibold">HenÃ¼z gider eklenmedi</p></div>}</div>
            </div>
          )}

          {activeTab === 'arsiv' && (
            <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-6 fade-in"><h2 className="font-bold text-xl mb-4 text-gray-800">ArÅŸivlenmiÅŸ KayÄ±tlar</h2><div className="space-y-2">{kayitlar.filter(k=>k.arsivlendi).map(k=>(<div key={k.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition"><div><p className="font-semibold text-gray-900">{k.adSoyad}</p><p className="text-sm text-gray-500">{k.donem} - {k.egitimCesidi}</p></div><button onClick={()=>{ const yeni = kayitlar.map(x=>x.id===k.id?{...x, arsivlendi:false}:x); setKayitlar(yeni); DB.set('kayitlar', yeni); }} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition">Geri Al</button></div>))}</div>{kayitlar.filter(k=>k.arsivlendi).length===0 && <div className="text-center py-16"><Icon name="Archive" size={64} className="text-gray-300 mx-auto mb-4" /><p className="text-gray-400 font-semibold">ArÅŸiv boÅŸ</p></div>}</div>
          )}

          {activeTab === 'yonetim' && currentUser.role === 'admin' && (
            <div className="fade-in space-y-6">
              <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-6"><div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="Users" size={28} className="text-purple-600" />KullanÄ±cÄ± YÃ¶netimi</h2><p className="text-gray-500 text-sm mt-1">{Object.keys(users).length} aktif kullanÄ±cÄ±</p></div><button onClick={() => { const username = prompt('KullanÄ±cÄ± adÄ±:'); if (!username) return; if (users[username]) { alert('Bu kullanÄ±cÄ± adÄ± zaten mevcut!'); return; } const password = prompt('Åžifre:'); if (!password) return; const name = prompt('Ad Soyad:'); if (!name) return; const role = confirm('Admin yetkisi verilsin mi?\n\nEVET: Admin\nHAYIR: Sekreter') ? 'admin' : 'sekreter'; UserManager.addUser(username, password, role, name); setUsers(UserManager.getUsers()); ActivityLog.log(currentUser.username, 'KULLANICI EKLEME', name + ' (' + username + ') - ' + role); setActivityLogs(ActivityLog.getLogs()); alert('âœ… KullanÄ±cÄ± baÅŸarÄ±yla eklendi!'); }} className="gradient-green text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition"><Icon name="UserPlus" size={20} />KullanÄ±cÄ± Ekle</button></div><div className="grid gap-4">{Object.entries(users).map(([username, user]) => (<div key={username} className="flex items-center justify-between p-5 bg-gradient-to-r from-purple-50 to-white rounded-2xl border border-purple-100 hover:shadow-md transition"><div className="flex items-center gap-4"><div className={'w-14 h-14 rounded-full flex items-center justify-center ' + (user.role === 'admin' ? 'bg-purple-600' : 'bg-blue-600')}><Icon name={user.role === 'admin' ? 'Shield' : 'User'} size={28} className="text-white" /></div><div><h3 className="font-bold text-lg text-gray-900">{user.name}</h3><p className="text-sm text-gray-600">@{username}</p><div className="flex items-center gap-2 mt-1"><span className={'badge ' + (user.role === 'admin' ? 'badge-danger' : 'badge-info')}>{user.role === 'admin' ? 'YÃ¶netici' : 'Sekreter'}</span><span className={'badge ' + (user.active ? 'badge-success' : 'badge-warning')}>{user.active ? 'Aktif' : 'Pasif'}</span></div></div></div><div className="flex gap-2"><button onClick={() => { const newPassword = prompt(user.name + ' iÃ§in yeni ÅŸifre:'); if (newPassword) { UserManager.updateUser(username, { password: newPassword }); setUsers(UserManager.getUsers()); ActivityLog.log(currentUser.username, 'ÅžÄ°FRE SIFIRLAMA', user.name + ' (' + username + ')'); setActivityLogs(ActivityLog.getLogs()); alert('âœ… Åžifre baÅŸarÄ±yla deÄŸiÅŸtirildi!'); } }} className="px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg font-semibold transition flex items-center gap-2"><Icon name="Key" size={16} />Åžifre</button><button onClick={() => { UserManager.updateUser(username, { active: !user.active }); setUsers(UserManager.getUsers()); ActivityLog.log(currentUser.username, user.active ? 'KULLANICI DEVRE DIÅžI' : 'KULLANICI AKTÄ°F', user.name + ' (' + username + ')'); setActivityLogs(ActivityLog.getLogs()); }} className={'px-4 py-2 rounded-lg font-semibold transition ' + (user.active ? 'bg-amber-50 hover:bg-amber-100 text-amber-600' : 'bg-green-50 hover:bg-green-100 text-green-600')}><Icon name={user.active ? 'UserX' : 'UserCheck'} size={16} /></button>{username !== 'aksu' && username !== currentUser.username && <button onClick={() => { if (confirm(user.name + ' kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz?')) { UserManager.deleteUser(username); setUsers(UserManager.getUsers()); ActivityLog.log(currentUser.username, 'KULLANICI SÄ°LME', user.name + ' (' + username + ')'); setActivityLogs(ActivityLog.getLogs()); } }} className="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition"><Icon name="Trash2" size={16} /></button>}</div></div>))}</div></div>
              <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-6"><div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="Activity" size={28} className="text-blue-600" />Aktivite LoglarÄ±</h2><p className="text-gray-500 text-sm mt-1">Son {activityLogs.length} iÅŸlem</p></div><div className="flex gap-2"><button onClick={() => setActivityLogs(ActivityLog.getLogs())} className="px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg font-semibold transition"><Icon name="RefreshCw" size={18} className="inline mr-2" />Yenile</button><button onClick={() => { if (confirm('TÃ¼m loglarÄ± silmek istediÄŸinize emin misiniz?')) { ActivityLog.clearLogs(); setActivityLogs([]); alert('âœ… Loglar temizlendi!'); } }} className="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg font-semibold transition"><Icon name="Trash2" size={18} className="inline mr-2" />Temizle</button></div></div><div className="space-y-2 max-h-[600px] overflow-y-auto">{activityLogs.map(log => (<div key={log.id} className="flex items-start gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition"><div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><Icon name="Activity" size={20} className="text-blue-600" /></div><div className="flex-1 min-w-0"><div className="flex items-center gap-2 mb-1"><span className="font-bold text-gray-900">{log.username}</span><span className="badge badge-info">{log.action}</span></div>{log.details && <p className="text-sm text-gray-600 truncate">{log.details}</p>}<p className="text-xs text-gray-400 mt-1">{new Date(log.timestamp).toLocaleString('tr-TR')}</p></div></div>))}{activityLogs.length === 0 && <div className="text-center py-16"><Icon name="Activity" size={64} className="text-gray-300 mx-auto mb-4" /><p className="text-gray-400 font-semibold">HenÃ¼z aktivite kaydÄ± yok</p></div>}</div></div>
            </div>
          )}
        </main>
      </div>

      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-30"><div className="flex justify-around py-2">{MENU.slice(0, 5).map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={'flex flex-col items-center p-2 rounded-xl transition ' + (activeTab === item.id ? 'text-green-600' : 'text-gray-500')}><Icon name={item.icon} size={20} /><span className="text-xs mt-1 font-medium">{item.label.split(' ')[0]}</span></button>))}</div></nav>

      {editModal.open && <KayitForm viewMode={editModal.mode} editItem={editModal.item} onClose={()=>setEditModal({open:false, item:null, mode:null})} onSave={handleSave} />}
      {tahsilatModal && <TahsilatModal student={tahsilatModal} onClose={()=>setTahsilatModal(null)} onConfirm={handleTahsilat} />}
      {giderModal && <GiderModal onClose={()=>setGiderModal(false)} onSave={saveGider} />}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>
